<!DOCTYPE html><HTML lang="en"><head><script charset="utf-8" src="../../../../assets/default/multidoc_injector.js" type="text/javascript"></script><script charset="utf-8" type="text/javascript">window.MULTIDOCUMENTER_ROOT_PATH = '/'</script><script charset="utf-8" src="../../../../assets/default/flexsearch.bundle.js" type="text/javascript"></script><script charset="utf-8" src="../../../../assets/default/flexsearch_integration.js" type="text/javascript"></script><meta charset="UTF-8"/><meta content="width=device-width, initial-scale=1.0" name="viewport"/><title>Surrogate models · SpectralFitting.jl</title><meta content="Surrogate models · SpectralFitting.jl" name="title"/><meta content="Surrogate models · SpectralFitting.jl" property="og:title"/><meta content="Surrogate models · SpectralFitting.jl" property="twitter:title"/><meta content="Documentation for SpectralFitting.jl." name="description"/><meta content="Documentation for SpectralFitting.jl." property="og:description"/><meta content="Documentation for SpectralFitting.jl." property="twitter:description"/><script data-outdated-warner="" src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script data-main="../../assets/documenter.js" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" data-theme-name="catppuccin-mocha" href="../../assets/themes/catppuccin-mocha.css" rel="stylesheet" type="text/css"/><link class="docs-theme-link" data-theme-name="catppuccin-macchiato" href="../../assets/themes/catppuccin-macchiato.css" rel="stylesheet" type="text/css"/><link class="docs-theme-link" data-theme-name="catppuccin-frappe" href="../../assets/themes/catppuccin-frappe.css" rel="stylesheet" type="text/css"/><link class="docs-theme-link" data-theme-name="catppuccin-latte" href="../../assets/themes/catppuccin-latte.css" rel="stylesheet" type="text/css"/><link class="docs-theme-link" data-theme-name="documenter-dark" data-theme-primary-dark="" href="../../assets/themes/documenter-dark.css" rel="stylesheet" type="text/css"/><link class="docs-theme-link" data-theme-name="documenter-light" data-theme-primary="" href="../../assets/themes/documenter-light.css" rel="stylesheet" type="text/css"/><script src="../../assets/themeswap.js"></script><link href="https://JuliaAstro.org/SpectralFitting/stable/models/surrogate-models/" rel="canonical"/><link href="../../../../assets/default/multidoc.css" rel="stylesheet" type="text/css"/><link href="../../../../assets/default/flexsearch.css" rel="stylesheet" type="text/css"/></head><body><nav id="multi-page-nav"><a class="brand" href="../../../.."><img alt="home" src="../../../../assets/logo.svg"/></a><div class="hidden-on-mobile" id="nav-items"><a class="nav-link nav-item" href="../../../../home/">Home</a><div class="nav-dropdown"><button class="nav-item dropdown-label">Domain</button><div class="nav-dropdown-container nav-mega-dropdown-container"><div class="nav-mega-column"><div class="column-header">Solar System</div><ul class="column-content"><a class="nav-link nav-item" href="../../../../CALCEPH/">⬤ CALCEPH</a><a class="nav-link nav-item" href="https://juliaastro.org/EphemerisSources.jl" target="_blank">⬤ EphemerisSources</a><a class="nav-link nav-item" href="https://juliaastro.org/GeneralAstrodynamics.jl" target="_blank">⬤ GeneralAstrodynamics</a><a class="nav-link nav-item" href="https://github.com/PerezHz/HORIZONS.jl?tab=readme-ov-file#horizonsjl" target="_blank">⬤ HORIZONS</a><a class="nav-link nav-item" href="https://juliaspace.github.io/SatelliteToolbox.jl/stable/" target="_blank">⬤ SatelliteToolbox</a><a class="nav-link nav-item" href="../../../../SolarPosition/">⬤ SolarPosition</a><a class="nav-link nav-item" href="../../../../SPICE/">⬤ SPICE</a></ul></div><div class="nav-mega-column"><div class="column-header">Exoplanets</div><ul class="column-content"><a class="nav-link nav-item" href="http://JuliaHCI.github.io/ADI.jl/stable/" target="_blank">⬤ ADI</a><a class="nav-link nav-item" href="http://JuliaHCI.github.io/HCIToolbox.jl/stable/" target="_blank">⬤ HCIToolbox</a><a class="nav-link nav-item" href="../../../../Orbits/">⬤ Orbits</a><a class="nav-link nav-item" href="https://sefffal.github.io/PlanetOrbits.jl/dev/" target="_blank">⬤ PlanetOrbits</a><a class="nav-link nav-item" href="../../../../Transits/">⬤ Transits</a></ul></div><div class="nav-mega-column"><div class="column-header">Stars</div><ul class="column-content"><a class="nav-link nav-item" href="https://cgarling.github.io/BolometricCorrections.jl/stable/" target="_blank">⬤ BolometricCorrections</a><a class="nav-link nav-item" href="https://cgarling.github.io/InitialMassFunctions.jl/stable/" target="_blank">⬤ InitialMassFunctions</a><a class="nav-link nav-item" href="https://cgarling.github.io/StarFormationHistories.jl/stable/" target="_blank">⬤ StarFormationHistories</a></ul></div><div class="nav-mega-column"><div class="column-header">Galaxies and Cosmology</div><ul class="column-content"><a class="nav-link nav-item" href="../../../../Cosmology/">⬤ Cosmology</a><a class="nav-link nav-item" href="../../../../DustExtinction/">⬤ DustExtinction</a><a class="nav-link nav-item" href="https://ehtjulia.github.io/ScatteringOptics.jl/stable/" target="_blank">⬤ ScatteringOptics</a></ul></div></div></div><div class="nav-dropdown"><button class="nav-item dropdown-label">Techniques</button><div class="nav-dropdown-container nav-mega-dropdown-container"><div class="nav-mega-column"><div class="column-header">Photometry</div><ul class="column-content"><a class="nav-link nav-item" href="../../../../CCDReduction/">⬤ CCDReduction</a><a class="nav-link nav-item" href="../../../../LACosmic/">⬤ LACosmic</a><a class="nav-link nav-item" href="../../../../Photometry/">⬤ Photometry</a><a class="nav-link nav-item" href="../../../../PhotometricFilters/">⬤ PhotometricFilters</a><a class="nav-link nav-item" href="../../../../PSFModels/">⬤ PSFModels</a><a class="nav-link nav-item" href="../../../../SAOImageDS9/">⬤ SAOImageDS9</a></ul></div><div class="nav-mega-column"><div class="column-header">Astrometry</div><ul class="column-content"><a class="nav-link nav-item" href="https://barrettp.github.io/Astrometry/dev" target="_blank">⬤ Astrometry</a><a class="nav-link nav-item" href="../../../../AstroTime/">⬤ AstroTime</a><a class="nav-link nav-item" href="../../../../EarthOrientation/">⬤ EarthOrientation</a><a class="nav-link nav-item" href="../../../../ERFA/">◯ ERFA</a><a class="nav-link nav-item" href="../../../../Healpix/">⬤ Healpix</a><a class="nav-link nav-item" href="../../../../Reproject/">⬤ Reproject</a><a class="nav-link nav-item" href="../../../../SkyCoords/">⬤ SkyCoords</a><a class="nav-link nav-item" href="../../../../WCS/">◯ WCS</a></ul></div><div class="nav-mega-column"><div class="column-header">Spectroscopy</div><ul class="column-content"><a class="nav-link nav-item" href="https://ajwheeler.github.io/Korg.jl/stable/" target="_blank">⬤ Korg</a><a class="nav-link nav-item" href="../../../../Spectra/">⬤ Spectra</a><a class="nav-link active nav-item" href="../../../">⬤ SpectralFitting</a></ul></div><div class="nav-mega-column"><div class="column-header">Time Series Analysis</div><ul class="column-content"><a class="nav-link nav-item" href="https://docs.juliadsp.org/stable/" target="_blank">⬤ DSP</a><a class="nav-link nav-item" href="../../../../LombScargle/">⬤ LombScargle</a><a class="nav-link nav-item" href="https://juliastats.github.io/TimeSeries.jl/stable" target="_blank">⬤ TimeSeries</a></ul></div><div class="nav-mega-column"><div class="column-header">Interferometry</div><ul class="column-content"><a class="nav-link nav-item" href="https://ptiede.github.io/Comrade.jl/stable/" target="_blank">⬤ Comrade</a><a class="nav-link nav-item" href="https://aplavin.github.io/Difmap.jl/test/examples.html" target="_blank">⬤ Difmap</a><a class="nav-link nav-item" href="https://github.com/emmt/OIFITS.jl?tab=readme-ov-file#support-for-oi-fits-data-in-julia" target="_blank">⬤ OIFITS</a><a class="nav-link nav-item" href="https://fabienbaron.github.io/OITOOLS.jl/dev" target="_blank">⬤ OITOOLS</a><a class="nav-link nav-item" href="https://ehtjulia.github.io/PolarizedTypes.jl/stable/" target="_blank">⬤ PolarizedTypes</a><a class="nav-link nav-item" href="https://aplavin.github.io/VLBIData.jl/test/examples.html" target="_blank">⬤ VLBIData</a><a class="nav-link nav-item" href="https://ehtjulia.github.io/VLBISkyModels.jl/stable/" target="_blank">⬤ VLBISkyModels</a></ul></div></div></div><div class="nav-dropdown"><button class="nav-item dropdown-label">Statistics</button><div class="nav-dropdown-container nav-mega-dropdown-container"><div class="nav-mega-column"><div class="column-header">Uncertainty</div><ul class="column-content"><a class="nav-link nav-item" href="https://juliaphysics.github.io/Measurements.jl/stable/" target="_blank">⬤ Measurements</a><a class="nav-link nav-item" href="https://baggepinnen.github.io/MonteCarloMeasurements.jl/stable/" target="_blank">⬤ MonteCarloMeasurements</a><a class="nav-link nav-item" href="https://baggepinnen.github.io/MonteCarloMeasurements.jl/stable/" target="_blank">⬤ Uncertain</a></ul></div><div class="nav-mega-column"><div class="column-header">Optimization</div><ul class="column-content"><a class="nav-link nav-item" href="../../../../BoxLeastSquares/">⬤ BoxLeastSquares</a><a class="nav-link nav-item" href="http://jump.dev/JuMP.jl/" target="_blank">⬤ JuMP</a><a class="nav-link nav-item" href="https://docs.sciml.ai/NonlinearSolve/stable/" target="_blank">⬤ NonlinearSolve</a><a class="nav-link nav-item" href="https://docs.sciml.ai/Optimization/stable/" target="_blank">⬤ Optimization</a></ul></div><div class="nav-mega-column"><div class="column-header">General</div><ul class="column-content"><a class="nav-link nav-item" href="../../../../AstroLib/">⬤ AstroLib</a><a class="nav-link nav-item" href="http://mileslucas.com/BiweightStats.jl/stable/" target="_blank">⬤ BiweightStats</a><a class="nav-link nav-item" href="https://github.com/jeff-regier/Celeste.jl/wiki/" target="_blank">⬤ Celeste</a><a class="nav-link nav-item" href="https://juliastats.org/" target="_blank">⬤ JuliaStats</a><a class="nav-link nav-item" href="https://juliastats.github.io/Distributions.jl/stable/" target="_blank">⬤ Distributions</a><a class="nav-link nav-item" href="https://ehtjulia.github.io/FastHartleyTransform.jl/stable/" target="_blank">⬤ FastHartleyTransform</a><a class="nav-link nav-item" href="https://sefffal.github.io/Octofitter.jl/dev" target="_blank">⬤ Octofitter</a></ul></div></div></div><div class="nav-dropdown"><button class="nav-item dropdown-label">Utilities</button><div class="nav-dropdown-container nav-mega-dropdown-container"><div class="nav-mega-column"><div class="column-header">Data I/O</div><ul class="column-content"><a class="nav-link nav-item" href="../../../../ASDF2/">⬤ ASDF2</a><a class="nav-link nav-item" href="../../../../AstroImages/">⬤ AstroImages</a><a class="nav-link nav-item" href="../../../../CFITSIO/">◯ CFITSIO</a><a class="nav-link nav-item" href="https://emmt.github.io/EasyFITS.jl/dev" target="_blank">⬤ EasyFITS</a><a class="nav-link nav-item" href="../../../../FITSFiles/">⬤ FITSFiles</a><a class="nav-link nav-item" href="../../../../FITSIO/">◯ FITSIO</a><a class="nav-link nav-item" href="https://github.com/JuliaAPlavin/FixedWidthTables.jl?tab=readme-ov-file#fixedwidthtablesjl" target="_blank">⬤ FixedWidthTables</a><a class="nav-link nav-item" href="https://aplavin.github.io/SkyImages.jl/test/notebook.html" target="_blank">⬤ SkyImages</a><a class="nav-link nav-item" href="https://github.com/JuliaAPlavin/VirtualObservatory.jl?tab=readme-ov-file#virtualobservatoryjl" target="_blank">⬤ VirtualObservatory</a><a class="nav-link nav-item" href="https://github.com/JuliaAPlavin/VOTables.jl" target="_blank">⬤ VOTables</a><a class="nav-link nav-item" href="../../../../XPA/">⬤ XPA</a></ul></div><div class="nav-mega-column"><div class="column-header">Data processing</div><ul class="column-content"><a class="nav-link nav-item" href="../../../../Astroalign/">⬤ Astroalign</a><a class="nav-link nav-item" href="../../../../BackgroundMeshes/">⬤ BackgroundMeshes</a><a class="nav-link nav-item" href="https://github.com/torrance/Casacore.jl?tab=readme-ov-file#casacorejl" target="_blank">⬤ Casacore</a><a class="nav-link nav-item" href="https://dataframes.juliadata.org/stable/" target="_blank">⬤ DataFrames</a><a class="nav-link nav-item" href="https://rafaqz.github.io/DimensionalData.jl/stable/" target="_blank">⬤ DimensionalData</a><a class="nav-link nav-item" href="https://aplavin.github.io/FlexiJoins.jl/test/examples.html" target="_blank">⬤ FlexiJoins</a><a class="nav-link nav-item" href="https://github.com/gcalderone/SortMerge.jl?tab=readme-ov-file#sortmerge" target="_blank">⬤ SortMerge</a></ul></div><div class="nav-mega-column"><div class="column-header">Data Viz</div><ul class="column-content"><a class="nav-link nav-item" href="../../../../AstroImages/">⬤ AstroImages</a><a class="nav-link nav-item" href="https://juliaimages.github.io/ImageFiltering.jl/stable" target="_blank">⬤ ImageFiltering</a><a class="nav-link nav-item" href="https://manuelbehrendt.github.io/Mera.jl/stable/" target="_blank">⬤ Mera</a><a class="nav-link nav-item" href="https://sefffal.github.io/PairPlots.jl/dev/" target="_blank">⬤ PairPlots</a><a class="nav-link nav-item" href="https://aplavin.github.io/SkyImages.jl/test/notebook.html" target="_blank">⬤ SkyImages</a></ul></div><div class="nav-mega-column"><div class="column-header">Units/Constants</div><ul class="column-content"><a class="nav-link nav-item" href="../../../../AstroAngles/">⬤ AstroAngles</a><a class="nav-link nav-item" href="https://symbolicml.org/DynamicQuantities.jl/stable/" target="_blank">⬤ DynamicQuantities</a><a class="nav-link nav-item" href="https://juliaphysics.github.io/PhysicalConstants.jl/stable/" target="_blank">⬤ PhysicalConstants</a><a class="nav-link nav-item" href="https://painterqubits.github.io/Unitful.jl/stable" target="_blank">⬤ Unitful</a><a class="nav-link nav-item" href="../../../../UnitfulAstro/">⬤ UnitfulAstro</a></ul></div></div></div><div class="search nav-item"><input id="search-input" placeholder="Search everywhere..."/><ul class="suggestions hidden" id="search-result-container"></ul><div class="search-keybinding">/</div></div></div><button id="multidoc-toggler"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg></button></nav><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img alt="SpectralFitting.jl logo" src="../../assets/logo.svg"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">SpectralFitting.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../walkthrough/">Walkthrough</a></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../../examples/examples/">Diverse examples</a></li><li><a class="tocitem" href="../../examples/sherpa-example/">A quick guide</a></li></ul></li><li><span class="tocitem">Fitting</span><ul><li><a class="tocitem" href="../../parameters/">Parameters</a></li></ul></li><li><span class="tocitem">Models</span><ul><li><a class="tocitem" href="../using-models/">Using models</a></li><li><a class="tocitem" href="../models/">Model index</a></li><li><a class="tocitem" href="../composite-models/">Composite models</a></li><li><a class="tocitem" href="../wrapper-models/">Wrapper models</a></li><li class="is-active"><a class="tocitem" href="">Surrogate models</a><ul class="internal"><li><a class="tocitem" href="#Surrogates-overview"><span>Surrogates overview</span></a></li><li><a class="tocitem" href="#Creating-a-surrogate-for-XS_PhotoelectricAbsorption"><span>Creating a surrogate for <code>XS_PhotoelectricAbsorption</code></span></a></li><li><a class="tocitem" href="#Using-a-surrogate-spectral-model"><span>Using a surrogate spectral model</span></a></li><li><a class="tocitem" href="#Evaluating-the-model"><span>Evaluating the model</span></a></li><li><a class="tocitem" href="#Sharing-surrogate-models"><span>Sharing surrogate models</span></a></li></ul></li><li><a class="tocitem" href="../xspec-models/">XSPEC models</a></li></ul></li><li><span class="tocitem">Datasets</span><ul><li><a class="tocitem" href="../../datasets/datasets/">Using datasets</a></li><li><a class="tocitem" href="../../datasets/mission-support/">Mission support</a></li></ul></li><li><a class="tocitem" href="../../why-and-how/">Why &amp; How</a></li><li><a class="tocitem" href="../../reference/">Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" href="#" id="documenter-sidebar-button"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Models</a></li><li class="is-active"><a href="">Surrogate models</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="">Surrogate models</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaAstro/SpectralFitting.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/JuliaAstro/SpectralFitting.jl/blob/main/docs/src/models/surrogate-models.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" href="#" id="documenter-settings-button" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" href="javascript:;" id="documenter-article-toggle-button" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Surrogate-models"><a class="docs-heading-anchor" href="#Surrogate-models">Surrogate models</a><a id="Surrogate-models-1"></a><a class="docs-heading-anchor-permalink" href="#Surrogate-models" title="Permalink"></a></h1><p>Surrogate models allow you to create fast or memory efficient approximations of model components, or assist in optimizing some objective function directly. SpectralFitting uses the <a href="https://github.com/SciML/Surrogates.jl">Surrogates.jl</a> library of models, that yields pure-Julia surrogate models. Consequently, surrogate models also permit use of automatic differentiation in fitting, and are therefore powerful tools for improving fitting performance.</p><h2 id="Surrogates-overview"><a class="docs-heading-anchor" href="#Surrogates-overview">Surrogates overview</a><a id="Surrogates-overview-1"></a><a class="docs-heading-anchor-permalink" href="#Surrogates-overview" title="Permalink"></a></h2><div class="admonition is-warning" id="Warning-49c960de9a17c48b"><header class="admonition-header">Warning<a class="admonition-anchor" href="#Warning-49c960de9a17c48b" title="Permalink"></a></header><div class="admonition-body"><p>The surrogate model optimization does not work well for most XSPEC models currently. This is being actively developed.</p></div></div><p>Any function may be wrapped as a surrogate model using the <a href="#SpectralFitting.SurrogateSpectralModel"><code>SurrogateSpectralModel</code></a> type.</p><article><details class="docstring" open="true"><summary id="SpectralFitting.SurrogateSpectralModel"><a class="docstring-binding" href="#SpectralFitting.SurrogateSpectralModel"><code>SpectralFitting.SurrogateSpectralModel</code></a> — <span class="docstring-category">Type</span></summary><section><div><pre><code class="language-julia hljs">SurrogateSpectralModel &lt;: AbstractSpectralModel
SurrogateSpectralModel(modelkind, surrogate, params, params_symbols)</code></pre><p>Used to wrap a surrogate function into an <a href="../using-models/#SpectralFitting.AbstractSpectralModel"><code>AbstractSpectralModel</code></a>.</p><p><strong>Example</strong></p><p>Creating a surrogate function using <a href="#SpectralFitting.make_surrogate_harness"><code>make_surrogate_harness</code></a>:</p><pre><code class="language-julia hljs"># build and optimize a surrogate model
surrogate = make_surrogate_harness(model, lower_bounds, upper_bounds)

# create surrogate spectral model
sm = SurrogateSpectralModel(
    Multiplicative(),
    surrogate,
    (FitParam(1.0),),
    (:ηH,)
)</code></pre><p>The <code>lower_bounds</code> and <code>upper_bounds</code> must be tuples in the form <code>(E, params...)</code>, where <code>E</code> denotes the bounds on the energy range to train over.</p></div><a class="docs-sourcelink" href="https://github.com/JuliaAstro/SpectralFitting.jl/blob/e83fbafcb10d79e59fbd3d8ac780f009568e0aa3/src/meta-models/surrogate-models.jl#L1-L25" target="_blank">source</a></section></details></article><p>To facilitate easy surrogate builds, SpectralFitting exports a number of utility functions.</p><article><details class="docstring" open="true"><summary id="SpectralFitting.make_surrogate_harness"><a class="docstring-binding" href="#SpectralFitting.make_surrogate_harness"><code>SpectralFitting.make_surrogate_harness</code></a> — <span class="docstring-category">Function</span></summary><section><div><pre><code class="language-julia hljs">make_surrogate_harness(
    model::M,
    lowerbounds::T,
    upperbounds::T;
    optimization_samples = 200,
    seed_samples = 50,
    S::Type = RadialBasis,
    sample_type = SobolSample(),
    verbose = false,
)</code></pre><p>Creates and optimizes a surrogate model of type <code>S</code> for <code>model</code>, using <a href="../models/#SpectralFitting.wrap_model_as_objective"><code>wrap_model_as_objective</code></a> and  <a href="#SpectralFitting.optimize_accuracy!"><code>optimize_accuracy!</code></a> for <code>optimization_samples</code> iterations. Model is initially seeded with <code>seed_samples</code> points prior to optimization.</p><div class="admonition is-warning" id="Warning-3a0cee51e4c64ade"><header class="admonition-header">Warning<a class="admonition-anchor" href="#Warning-3a0cee51e4c64ade" title="Permalink"></a></header><div class="admonition-body"><p>Additive models integrate energies to calculate flux, which surrogate models are currently not capable of. Results for Additive models likely to be inaccurate. This will be patched in a future version.</p></div></div></div><a class="docs-sourcelink" href="https://github.com/JuliaAstro/SpectralFitting.jl/blob/e83fbafcb10d79e59fbd3d8ac780f009568e0aa3/src/meta-models/surrogate-models.jl#L158-L178" target="_blank">source</a></section></details></article><article><details class="docstring" open="true"><summary id="SpectralFitting.optimize_accuracy!"><a class="docstring-binding" href="#SpectralFitting.optimize_accuracy!"><code>SpectralFitting.optimize_accuracy!</code></a> — <span class="docstring-category">Function</span></summary><section><div><pre><code class="language-julia hljs">optimize_accuracy!(
    surr::AbstractSurrogate,
    obj::Function,
    lb,
    ub;
    sample_type::SamplingAlgorithm = SobolSample(),
    maxiters = 200,
    N_truth = 5000,
    verbose = false,
)</code></pre><p>Improve accuracy (faithfullness) of the surrogate model in recreating the objective function.</p><p>Samples a new space of <code>N_truth</code> points between <code>lb</code> and <code>ub</code>, and calculates the objective function <code>obj</code> at each. Finds the point with largest MSE between surrogate and objective, and adds the point to the surrogate pool. Repeats <code>maxiters</code> times, adding <code>maxiters</code> points to surrogate model.</p><p>Optionally print to stdout the MSE and iteration count with <code>verbose = true</code>.</p><p>Note that upper- and lower-bounds should be in the form <code>(E, params...)</code>, where <code>E</code> is a single energy and <code>params</code> are the model parameters.</p></div><a class="docs-sourcelink" href="https://github.com/JuliaAstro/SpectralFitting.jl/blob/e83fbafcb10d79e59fbd3d8ac780f009568e0aa3/src/meta-models/surrogate-models.jl#L61-L84" target="_blank">source</a></section></details></article><h2 id="Creating-a-surrogate-for-XS_PhotoelectricAbsorption"><a class="docs-heading-anchor" href="#Creating-a-surrogate-for-XS_PhotoelectricAbsorption">Creating a surrogate for <code>XS_PhotoelectricAbsorption</code></a><a id="Creating-a-surrogate-for-XS_PhotoelectricAbsorption-1"></a><a class="docs-heading-anchor-permalink" href="#Creating-a-surrogate-for-XS_PhotoelectricAbsorption" title="Permalink"></a></h2><p>Before we start, let us discuss a number of benefits the use of surrogate models may bring us:</p><ul><li><a href="#SpectralFitting.SurrogateSpectralModel"><code>SurrogateSpectralModel</code></a> permit use of automatic differentiation.</li><li>Surrogate models may be allocation-free depending on setup, whereas XSPEC wrappers will always have to allocate for type-conversions.</li><li>Surrogate models may be considerably faster, especially for table models.</li><li>Surrogate models are shareable (see <a href="#Sharing-surrogate-models">Sharing surrogate models</a>), and are tunable in size.</li></ul><p><a href="../xspec-models/#XSPECModels.XS_PhotoelectricAbsorption"><code>XS_PhotoelectricAbsorption</code></a> is an XSPEC model that is wrapped by a thin C-wrapper into Julia. The implementation of this model is a number of Fortran routines from the late 90s, including a tabulation of ~3000 lines of data that has been copied directly into the Fortran source code.</p><p>The performance of this model represents its complexity.</p><pre><code class="language-julia hljs">using SpectralFitting, XSPECModels

energy = collect(range(0.1, 20.0, 200))
model = XS_PhotoelectricAbsorption()

flux = similar(energy)[1:end-1]</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">199-element Vector{Float64}:
 0.0
 7.1e-322
 2.5e-322
 6.94818216194357e-310
 6.94817869137984e-310
 0.0
 6.94818216194357e-310
 6.94817869137984e-310
 0.0
 6.94818216194357e-310
 ⋮
 6.94817869137984e-310
 0.0
 6.94818216194357e-310
 6.94817869137984e-310
 0.0
 6.94818216194357e-310
 6.94817869137984e-310
 0.0
 6.94818216194357e-310</code></pre><p>Benchmarking with <a href="https://juliaci.github.io/BenchmarkTools.jl/stable/">BenchmarkTools.jl</a>:</p><pre><code class="language-julia hljs">using BenchmarkTools
@benchmark invokemodel!($flux, $energy, $model)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">BenchmarkTools.Trial: 4933 samples with 1 evaluation per sample.
 Range <span class="sgr90">(</span><span class="sgr36"><span class="sgr1">min</span></span> … <span class="sgr35">max</span><span class="sgr90">):  </span><span class="sgr36"><span class="sgr1">1.003 ms</span></span> … <span class="sgr35"> 1.391 ms</span>  <span class="sgr90">┊</span> GC <span class="sgr90">(</span>min … max<span class="sgr90">): </span>0.00% … 0.00%
 Time  <span class="sgr90">(</span><span class="sgr34"><span class="sgr1">median</span></span><span class="sgr90">):     </span><span class="sgr34"><span class="sgr1">1.008 ms              </span></span><span class="sgr90">┊</span> GC <span class="sgr90">(</span>median<span class="sgr90">):    </span>0.00%
 Time  <span class="sgr90">(</span><span class="sgr32"><span class="sgr1">mean</span></span> ± <span class="sgr32">σ</span><span class="sgr90">):   </span><span class="sgr32"><span class="sgr1">1.010 ms</span></span> ± <span class="sgr32">12.640 μs</span>  <span class="sgr90">┊</span> GC <span class="sgr90">(</span>mean ± σ<span class="sgr90">):  </span>0.00% ± 0.00%

       ▃▆█<span class="sgr34">▆</span>▃<span class="sgr32">▁</span>                                                 
  ▂▂▃▅▇███<span class="sgr34">█</span>█<span class="sgr32">█</span>▇▅▄▃▃▃▃▃▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▁▁▂▂▁▁▂▂▂▂▂▂▂▂ ▃
  1 ms<span class="sgr90">           Histogram: frequency by time</span>        1.04 ms <span class="sgr1">&lt;</span>

 Memory estimate<span class="sgr90">: </span><span class="sgr33">224 bytes</span>, allocs estimate<span class="sgr90">: </span><span class="sgr33">7</span>.</code></pre><p>The surrogate we'll construct will have to be tailored a little to the data we wish to fit, as we need to specify the parameter ranges our surrogate should learn. For example, we might be interested in energies between <span>$0.1$</span> and <span>$20$</span> keV (expressed in our domain), with equivalent hydrogen column <span>$\eta$</span>H anywhere between <span>$10^{-3}$</span> and <span>$30$</span>. We specify the parameter bounds using tuples:</p><pre><code class="language-julia hljs">lower_bounds = (1e-3,)
upper_bounds = (30.0,)</code></pre><div class="admonition is-info" id="Note-5e8119db9ecc9c02"><header class="admonition-header">Note<a class="admonition-anchor" href="#Note-5e8119db9ecc9c02" title="Permalink"></a></header><div class="admonition-body"><p>The first index is always the energy bounds, and the subsequent indices are the parameters in the same order they are defined in the model structure.</p></div></div><p>Next, we use <a href="#SpectralFitting.make_surrogate_harness"><code>make_surrogate_harness</code></a> to build and optimize a surrogate function for our model. By default, the surrogate uses linear radial basis functions, and seeds the coefficients with a number of seed points. This function then improves the accuracy of the model using <a href="#SpectralFitting.optimize_accuracy!"><code>optimize_accuracy!</code></a>, until a maximal number of iterations has been reached.</p><p>For illustration purposes, we'll omit the accuracy improving step, and perform this ourselves. We can do this by setting <code>optimization_samples = 0</code> in the keyword arguments:</p><pre><code class="language-julia hljs">using Surrogates

harness = make_surrogate_harness(
    (x, y) -&gt; RadialBasis(x, y, lower_bounds, upper_bounds),
    energy,
    model,
    lower_bounds,
    upper_bounds;
    # default is 50, but to illustrate the training behaviour we'll set this low
    seed_samples = 2,
)

# number of points the surrogate has been trained on
length(harness.surrogate.x)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2</code></pre><p>We can examine how well our surrogate reconstructs the model for a given test parameter:</p><pre><code class="language-julia hljs">using Plots
# random test value
ηh_test = 22.9

model.ηH.value = ηh_test
f = invokemodel(energy, model)

f̂ = harness.surrogate([ηh_test])</code></pre><img alt="Example block output" src="82ace3dd.svg"/><p>Now we'll use <a href="#SpectralFitting.optimize_accuracy!"><code>optimize_accuracy!</code></a> to improve the faithfulness of our surrogate. This requires making use of <a href="../models/#SpectralFitting.wrap_model_as_objective"><code>wrap_model_as_objective</code></a> as a little wrapper around our model:</p><pre><code class="language-julia hljs">optimize_accuracy!(harness; maxiters=50)

length(harness.surrogate.x)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">52</code></pre><p>We can plot the surrogate model again and see the improvement.</p><pre><code class="language-julia hljs">new_f̂ = harness.surrogate([ηh_test])</code></pre><img alt="Example block output" src="052df6ce.svg"/><p>Tight. We can also inspect the memory footprint of our model:</p><pre><code class="language-julia hljs"># in bytes
Base.summarysize(harness)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">173760</code></pre><p>This may be reduced by lowering <code>maxiters</code> in <a href="#SpectralFitting.optimize_accuracy!"><code>optimize_accuracy!</code></a> at the cost of decreasing faithfulness. However, compare this to the Fortran tabulated source file in the XSPEC source code, which is approximately 224 Kb. The surrogate model with all it's training data is of the same order.</p><h2 id="Using-a-surrogate-spectral-model"><a class="docs-heading-anchor" href="#Using-a-surrogate-spectral-model">Using a surrogate spectral model</a><a id="Using-a-surrogate-spectral-model-1"></a><a class="docs-heading-anchor-permalink" href="#Using-a-surrogate-spectral-model" title="Permalink"></a></h2><p>Now that we have the surrogate model, we use <a href="#SpectralFitting.SurrogateSpectralModel"><code>SurrogateSpectralModel</code></a> to wrap it into an <a href="../using-models/#SpectralFitting.AbstractSpectralModel"><code>AbstractSpectralModel</code></a>. The constructor also needs to know the model kind, have a copy of the model parameters, and know which symbols to represent the parameters with.</p><pre><code class="language-julia hljs">sm = make_model(harness)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">┌ SurrogateSpectralModel
│ ηH -&gt; 22.9 ± 0.1 ∈ [ 0, Inf ] <span class="sgr32">FREE</span>
└ </code></pre><p>We can now use the familiar API and attempt to benchmark the performance:</p><pre><code class="language-julia hljs">@benchmark invokemodel!($flux, $energy, $sm)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">BenchmarkTools.Trial: 10000 samples with 5 evaluations per sample.
 Range <span class="sgr90">(</span><span class="sgr36"><span class="sgr1">min</span></span> … <span class="sgr35">max</span><span class="sgr90">):  </span><span class="sgr36"><span class="sgr1">6.447 μs</span></span> … <span class="sgr35">84.065 μs</span>  <span class="sgr90">┊</span> GC <span class="sgr90">(</span>min … max<span class="sgr90">): </span>0.00% … 0.00%
 Time  <span class="sgr90">(</span><span class="sgr34"><span class="sgr1">median</span></span><span class="sgr90">):     </span><span class="sgr34"><span class="sgr1">6.544 μs              </span></span><span class="sgr90">┊</span> GC <span class="sgr90">(</span>median<span class="sgr90">):    </span>0.00%
 Time  <span class="sgr90">(</span><span class="sgr32"><span class="sgr1">mean</span></span> ± <span class="sgr32">σ</span><span class="sgr90">):   </span><span class="sgr32"><span class="sgr1">6.728 μs</span></span> ± <span class="sgr32"> 2.463 μs</span>  <span class="sgr90">┊</span> GC <span class="sgr90">(</span>mean ± σ<span class="sgr90">):  </span>0.00% ± 0.00%

  ▄▄█▆<span class="sgr34">▃</span>▁     <span class="sgr32"> </span>                                                
  ████<span class="sgr34">█</span>█▇▅▄▃▃<span class="sgr32">▂</span>▂▂▂▂▂▂▂▄▆▄▃▃▃▂▂▂▂▂▂▁▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂ ▃
  6.45 μs<span class="sgr90">        Histogram: frequency by time</span>        7.88 μs <span class="sgr1">&lt;</span>

 Memory estimate<span class="sgr90">: </span><span class="sgr33">1.72 KiB</span>, allocs estimate<span class="sgr90">: </span><span class="sgr33">5</span>.</code></pre><p>Comparing this to the initial benchmark of <a href="../xspec-models/#XSPECModels.XS_PhotoelectricAbsorption"><code>XS_PhotoelectricAbsorption</code></a>, we see about a significant speedup, with no allocations, <em>and</em> this surrogate model is now automatic differentiation ready.</p><h2 id="Evaluating-the-model"><a class="docs-heading-anchor" href="#Evaluating-the-model">Evaluating the model</a><a id="Evaluating-the-model-1"></a><a class="docs-heading-anchor-permalink" href="#Evaluating-the-model" title="Permalink"></a></h2><pre><code class="language-julia hljs">p_range = collect(range(1.0, 30.0))

fluxes_vecs = map(p_range) do p
    model.ηH.value = p
    f = invokemodel(energy, model)
end
fluxes_mat = reduce(hcat, fluxes_vecs)

surface(p_range, energy[1:end-1], fluxes_mat, xlabel = "ηH", ylabel = "E", zlabel = "f", title = "Model")</code></pre><img alt="Example block output" src="cfeedd62.svg"/><pre><code class="language-julia hljs">s_fluxes_vecs = map(p_range) do p
    sm.params[1].value = p
    display(sm)
    f = invokemodel(energy, sm)
end
s_fluxes_mat = reduce(hcat, s_fluxes_vecs)

surface(p_range, energy[1:end-1], s_fluxes_mat, xlabel = "ηH", ylabel = "E", zlabel = "f", title = "Surrogate")</code></pre><img alt="Example block output" src="da313923.svg"/><h2 id="Sharing-surrogate-models"><a class="docs-heading-anchor" href="#Sharing-surrogate-models">Sharing surrogate models</a><a id="Sharing-surrogate-models-1"></a><a class="docs-heading-anchor-permalink" href="#Sharing-surrogate-models" title="Permalink"></a></h2><p>To export and import surrogate models, <a href="https://github.com/JuliaIO/JLD2.jl">JLD2.jl</a> is recommended.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../wrapper-models/">« Wrapper models</a><a class="docs-footer-nextpage" href="../xspec-models/">XSPEC models »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label></p><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div><p></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.16.1 on <span class="colophon-date" title="Tuesday 25 November 2025 15:04">Tuesday 25 November 2025</span>. Using Julia version 1.12.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></HTML>